---
globs: **/*.ts,**/*.js,**/*.svelte
---

# Code Generation Workflow

**MANDATORY FINAL STEPS**: Complete these steps before marking any code task as done:

1. ✅ Review design principles
2. ✅ Write tests (if applicable)
3. ✅ **Run tests and verify they pass** - `npm run test`
4. ✅ **Run lint and fix all issues** - `npm run lint` (must pass with zero errors)
5. ✅ **Final verification** - Both test and lint must pass before completion

## Step 0: Review Design Principles

**CRITICAL**: Review code against design principles before finalizing.

### Core Design Principles

- **Single Responsibility**: Each function/component does ONE thing well
- **DRY**: Check `src/lib/utils/` before writing new utilities - see [utilities.mdc](mdc:.cursor/rules/utilities.mdc)
- **KISS**: Simple solutions over complex ones
- **YAGNI**: Build only what's needed now
- **Separation of Concerns**: Separate data fetching, business logic, and UI
- **Theme Support**: All components MUST support both light and dark modes using CSS variables
- **Mobile-First Responsive Design**: All components MUST be mobile-first and responsive - see [responsive-design.mdc](mdc:.cursor/rules/responsive-design.mdc)

## When to Write Tests

Write tests for:
- ✅ New components, utilities, stores
- ❌ Style files (CSS) - lint only
- ❌ Configuration files - lint only

## Final Steps Workflow

### Step 1: Review Design Principles

Review code against the principles above. Refactor if needed.

### Step 2: Write Tests (If Applicable)

1. Create test file co-located with source (e.g., `Component.test.ts`)
2. Follow [testing.mdc](mdc:.cursor/rules/testing.mdc) guidelines
3. Aim for **≥90% coverage** (statements, branches, functions, lines)
4. See [TESTING.md](mdc:.cursor/docs/TESTING.md) for patterns

### Step 3: Run Tests

```bash
npm run test                      # Run all tests (MANDATORY)
npm run test -- path/to/file.test.ts  # Specific file
npm run test -- --coverage      # With coverage (≥90% required)
```

**Requirements**:
- ✅ **All tests MUST pass** - CI will fail if tests fail
- ✅ Coverage ≥90% (if tests written)
- ✅ **No test failures allowed** - Fix any failing tests before proceeding

### Step 4: Run Lint

```bash
npm run lint      # Check for issues (MANDATORY)
npm run lint:fix  # Auto-fix issues
```

**Requirements**:
- ✅ **Zero errors and warnings** - CI will fail if lint fails
- ✅ All code formatted correctly
- ✅ **Lint MUST pass** - Fix all linting issues before proceeding

### Step 5: Verify Responsiveness (Recommended for UI Components)

**RECOMMENDED**: When working on UI components or visual changes, verify responsiveness:

1. Check component on mobile viewport (375px width)
2. Verify desktop layout (≥768px)
3. Ensure no horizontal scrolling
4. Test touch interactions where applicable
5. Check both light and dark themes at all breakpoints

**Note**: This step is recommended but not mandatory for non-visual changes (e.g., API routes, utilities).

### Step 6: Final Verification

**CRITICAL**: Before marking complete, you MUST verify:

1. ✅ **Run both commands and confirm they pass:**
   ```bash
   npm run test  # Must pass
   npm run lint  # Must pass with zero errors
   ```

2. ✅ Design principles applied
3. ✅ No code duplication (checked utilities first)
4. ✅ Theme support implemented (light & dark modes using CSS variables)
5. ✅ Responsive design implemented (mobile-first approach)
6. ✅ **All tests pass** (if applicable) - CI will fail otherwise
7. ✅ Coverage ≥90% (if tests written)
8. ✅ **Lint passes with zero errors/warnings** - CI will fail otherwise
9. ✅ Component tested on mobile and desktop viewports (recommended for UI components)

**DO NOT mark code as complete until both `npm run test` and `npm run lint` pass successfully.**

## Quick Reference

**MANDATORY FINAL CHECKS** (run these before completing any task):

```bash
npm run test          # Run tests (MUST pass)
npm run lint          # Run lint (MUST pass with zero errors)
npm run test -- --coverage  # Check coverage (≥90% required)
npm run lint:fix      # Auto-fix lint issues
```

**Remember**: Both `npm run test` and `npm run lint` must pass before marking any code task as complete.

## Frontend Development Workflow

**RECOMMENDED**: When working on UI components or visual changes, check the local dev server:

1. **Start dev server**: `npm run dev` (typically runs on `http://localhost:5173`)
2. **Verify changes visually** in browser before marking complete
3. **Use browser DevTools** to test responsive breakpoints:
   - Mobile: 375px width (iPhone SE)
   - Desktop: ≥768px width
4. **Check both themes**: Verify light and dark modes
5. **Test interactions**: Ensure buttons, links, and interactive elements work correctly

**Note**: This is recommended but not mandatory for all changes. Non-visual changes (e.g., API routes, utilities, tests) may not require visual verification.

## Quick Reference

**MANDATORY FINAL CHECKS** (run these before completing any task):

```bash
npm run test          # Run tests (MUST pass)
npm run lint          # Run lint (MUST pass with zero errors)
npm run test -- --coverage  # Check coverage (≥90% required)
npm run lint:fix      # Auto-fix lint issues
```

**RECOMMENDED FOR UI COMPONENTS**:

```bash
npm run dev           # Start dev server to visually verify frontend changes
```

**Remember**: Both `npm run test` and `npm run lint` must pass before marking any code task as complete.

## Related Rules

- [Testing Standards](.cursor/rules/testing.mdc) - Testing requirements
- [Code Quality](.cursor/rules/code-quality.mdc) - Quality verification
- [Coding Conventions](.cursor/rules/coding-conventions.mdc) - Code style
- [Utilities Check](.cursor/rules/utilities.mdc) - DRY principles
- [Responsive Design](.cursor/rules/responsive-design.mdc) - Mobile-first responsive patterns
- [Testing Guide](.cursor/docs/TESTING.md) - Testing patterns

---

**Enforcement**: This rule is **always applied**. Design review + tests + lint are **mandatory** before completing any code task.
