---
alwaysApply: true
---

# Refactoring Standards

This rule defines mandatory requirements for all refactoring work.

## MANDATORY Requirements

### 1. Test Coverage: Minimum 90%

**CRITICAL**: All refactored code MUST maintain or achieve **≥90% test coverage** (statements, branches, functions, lines).

**Workflow**:
- **Before**: Check existing coverage with `npm test -- --coverage`
- **During**: Maintain existing tests, update for changes, add tests for new code
- **After**: Verify ≥90% coverage on all metrics, add tests if below threshold

**Failure to meet 90% coverage is a blocking issue** - refactoring is incomplete until coverage requirements are met.

### 2. No Lint Issues: Zero Tolerance

**CRITICAL**: All refactored code MUST have **zero ESLint/TypeScript errors or warnings**.

**Workflow**:
- **Before**: Check current lint status with `npm run lint`
- **During**: Follow lint rules, use `npm run lint:fix` for auto-fix
- **After**: Verify zero errors/warnings with `npm run lint` and `npm run lint:fix`

**Any lint errors or warnings are blocking issues** - refactoring is incomplete until all lint issues are resolved.

## Refactoring Process

### Step-by-Step Workflow

1. **Plan** - Identify scope, check existing coverage/lint status
2. **Run existing tests** - Ensure all pass before starting
3. **Refactor** - Make incremental changes, keep tests passing, check utilities first (see [utilities.mdc](mdc:.cursor/rules/utilities.mdc))
4. **Update tests** - Modify for changes, add for new code, cover edge cases
5. **Verify coverage** - Run `npm test -- --coverage`, ensure ≥90% on all metrics
6. **Run lint** - Run `npm run lint` and `npm run lint:fix`, fix all issues
7. **Final verification** - All tests pass, coverage ≥90%, zero lint issues

### Best Practices

**Code Quality**:
- Maintain functionality (don't change behavior unless required)
- Improve readability and reduce complexity
- Follow SOLID principles
- Check `src/lib/utils/` before writing new helpers

**Testing**:
- Test behavior, not implementation
- Maintain test quality (meaningful tests, not just coverage)
- Cover edge cases and error paths

**Incremental Changes**:
- Small, focused changes
- Keep tests passing throughout
- Review coverage and lint regularly

## Verification Checklist

Before marking refactoring as complete:

- [ ] All existing tests pass
- [ ] New tests added for new/changed code
- [ ] Test coverage ≥90% (statements, branches, functions, lines)
- [ ] `npm run lint` shows zero errors and warnings
- [ ] `npm run lint:fix` has been run
- [ ] Code follows [coding conventions](.cursor/rules/coding-conventions.mdc)
- [ ] Existing utilities checked before writing new code

## Related Documentation

- [Testing Standards](.cursor/rules/testing.mdc) - Testing guidelines
- [Coding Conventions](.cursor/rules/coding-conventions.mdc) - Code style
- [Code Quality](.cursor/rules/code-quality.mdc) - Quality verification
- [Testing Guide](.cursor/docs/TESTING.md) - Testing patterns
- [Utilities Check](.cursor/rules/utilities.mdc) - Check utilities first

## Enforcement

These requirements are **mandatory**:
- **90% test coverage is non-negotiable**
- **Zero lint issues is non-negotiable**
- **Both must be met** before refactoring is complete

Failure to meet these requirements blocks completion of the refactoring task.
