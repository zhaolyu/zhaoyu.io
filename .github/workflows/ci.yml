# GitHub Actions workflow for CI checks and deployment on pull requests
# 
# This workflow:
# - Triggers on pull request creation (opened) and reopening (reopened)
# - Runs type checking, linting, testing, and build verification in parallel
# - Deploys to Cloudflare Pages after successful build
# - Ensures code quality before merging
# 
# Optimizations:
# - Parallel job execution for faster feedback (~2-3 min vs ~4-5 min sequential)
# - All jobs include SvelteKit sync step for consistency
# - Build artifacts removed (deployment workflow builds directly)
# - Concurrency control prevents duplicate runs on rapid commits
# - Path-based filtering skips CI for docs/config-only changes
# - Draft PR skipping saves minutes until PR is ready for review

name: CI - Quality Checks and Build

on:
  pull_request:
    types: [opened, reopened]
    # Run CI on PRs targeting any branch (including feature/... branches)
    # Skip CI for documentation and config-only changes
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
      - '.gitignore'
      - '.prettierrc'
      - 'LICENSE'

# Prevent concurrent runs for the same branch/PR
# Cancels in-progress runs when a new commit is pushed
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check if this is a merge commit (skip CI since PR already passed)
  # Note: This is kept for consistency but won't apply to PR opened events
  check-merge-commit:
    runs-on: ubuntu-latest
    name: Check Merge Commit
    timeout-minutes: 1
    permissions:
      contents: read
    outputs:
      is_merge_commit: 'false'
    steps:
      - name: Set default output
        id: set-default
        run: |
          echo "is_merge_commit=false" >> $GITHUB_OUTPUT
          echo "‚úÖ PR opened event - CI will run normally"

  # Branch protection: Prevent direct pushes to main
  # Note: This is kept for consistency but won't apply to PR opened events
  branch-protection:
    runs-on: ubuntu-latest
    name: Branch Protection Check
    timeout-minutes: 2
    permissions:
      contents: read
    needs: check-merge-commit
    if: always()
    steps:
      - name: Branch protection passed
        run: |
          echo "‚úÖ Branch protection check passed (PR opened event)"

  # Parallel quality checks for faster feedback
  type-check:
    needs: [check-merge-commit, branch-protection]
    if: |
      (needs.branch-protection.result == 'success' || needs.branch-protection.result == 'skipped') &&
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-latest
    name: Type Check
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Sync SvelteKit
        working-directory: frontend
        run: npm run sync

      - name: Type check
        working-directory: frontend
        run: npm run check
        continue-on-error: false

  lint:
    needs: [check-merge-commit, branch-protection]
    if: |
      (needs.branch-protection.result == 'success' || needs.branch-protection.result == 'skipped') &&
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-latest
    name: Lint
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint
        continue-on-error: false

  test:
    needs: [check-merge-commit, branch-protection]
    if: |
      (needs.branch-protection.result == 'success' || needs.branch-protection.result == 'skipped') &&
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-latest
    name: Test
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Sync SvelteKit
        working-directory: frontend
        run: npm run sync

      - name: Run tests
        working-directory: frontend
        run: npm run test
        continue-on-error: false

  build:
    needs: [check-merge-commit, branch-protection]
    if: |
      (needs.branch-protection.result == 'success' || needs.branch-protection.result == 'skipped') &&
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-latest
    name: Build
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Sync SvelteKit
        working-directory: frontend
        run: npm run sync

      - name: Build
        working-directory: frontend
        run: npm run build
        continue-on-error: false

      - name: Verify build output
        working-directory: frontend
        run: |
          if [ ! -d "build" ]; then
            echo "‚ùå Error: build directory not found"
            exit 1
          fi
          if [ ! -f "build/index.html" ]; then
            echo "‚ùå Error: build/index.html not found"
            exit 1
          fi
          echo "‚úÖ Build output verified successfully"
          echo ""
          echo "Build statistics:"
          echo "  Total size: $(du -sh build/ | cut -f1)"
          echo "  Files: $(find build/ -type f | wc -l)"
          echo "  Directories: $(find build/ -type d | wc -l)"

  # Deploy to Cloudflare Pages after successful build
  deploy:
    needs: [check-merge-commit, branch-protection, build]
    if: |
      (needs.branch-protection.result == 'success' || needs.branch-protection.result == 'skipped') &&
      (needs.build.result == 'success') &&
      (github.event.pull_request.draft == false)
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    timeout-minutes: 15
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.13.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Sync SvelteKit
        working-directory: frontend
        run: npm run sync

      - name: Build
        working-directory: frontend
        run: npm run build
        continue-on-error: false

      - name: Verify build output
        working-directory: frontend
        run: |
          if [ ! -d "build" ]; then
            echo "‚ùå Error: build directory not found"
            exit 1
          fi
          if [ ! -f "build/index.html" ]; then
            echo "‚ùå Error: build/index.html not found"
            exit 1
          fi
          echo "‚úÖ Build output verified successfully"
          echo "Build size:"
          du -sh build/

      - name: Determine deployment type
        id: deployment
        run: |
          # Get the PR head branch (source branch)
          BRANCH="${{ github.event.pull_request.head.ref }}"
          
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "Deploying to PREVIEW (PR targeting main)"
          else
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "Deploying to PREVIEW (feature branch)"
          fi

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: zhaoyu-io
          directory: frontend/build
          branch: ${{ steps.deployment.outputs.branch }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Check deployment status
        if: steps.deploy.outcome == 'success'
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "Deployment may take a few moments to propagate."
      
      - name: Output Deployment URLs
        if: steps.deploy.outcome == 'success'
        run: |
          echo "üåê Deployment completed successfully!"
          echo ""
          echo "**Preview Deployment URLs:**"
          echo "  - Atomic URL: ${{ steps.deploy.outputs.url }}"
          echo "  - Branch Alias: ${{ steps.deploy.outputs.alias }}"
          echo ""
          echo "‚ö†Ô∏è  If you see 'Nothing is here yet' when visiting the URL:"
          echo "   1. Wait 1-2 minutes for deployment to propagate"
          echo "   2. Check Cloudflare Pages dashboard ‚Üí Deployments tab"
          echo "   3. Verify the deployment status is 'Success'"
      
      - name: Extract deployment URLs
        if: |
          steps.deployment.outputs.environment == 'preview' &&
          steps.deploy.outcome == 'success'
        id: extract-urls
        run: |
          echo "Extracting deployment URLs from Cloudflare Pages action..."
          ATOMIC_URL="${{ steps.deploy.outputs.url }}"
          ALIAS_URL="${{ steps.deploy.outputs.alias }}"
          
          if [ -z "$ATOMIC_URL" ]; then
            echo "‚ùå ERROR: Atomic URL is empty!"
            exit 1
          fi
          
          if [ -n "$ALIAS_URL" ] && [ "$ALIAS_URL" != "$ATOMIC_URL" ]; then
            echo "preview_url=$ALIAS_URL" >> $GITHUB_OUTPUT
          else
            echo "preview_url=$ATOMIC_URL" >> $GITHUB_OUTPUT
          fi
          echo "atomic_url=$ATOMIC_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Extracted preview URL: $(cat $GITHUB_OUTPUT | grep preview_url | cut -d'=' -f2-)"
      
      - name: Comment Preview URL on PR
        if: |
          steps.deployment.outputs.environment == 'preview' &&
          steps.deploy.outcome == 'success' &&
          steps.extract-urls.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const branch = '${{ steps.deployment.outputs.branch }}';
            
            console.log('‚úÖ Found PR #' + prNumber + ' for branch: ' + branch);
            
            // Get URLs from extract-urls step
            const previewUrl = '${{ steps.extract-urls.outputs.preview_url }}'.trim();
            const atomicUrl = '${{ steps.extract-urls.outputs.atomic_url }}'.trim();
            
            console.log('Deployment URLs:', {
              previewUrl: previewUrl || '(empty)',
              atomicUrl: atomicUrl || '(empty)',
              branch: branch
            });
            
            // Validate URL
            if (!previewUrl || previewUrl === '' || previewUrl === '${{ steps.extract-urls.outputs.preview_url }}') {
              console.error('‚ùå Preview URL is empty or not set!');
              console.error('Check the "Extract deployment URLs" step logs for details.');
              return;
            }
            
            console.log('Using preview URL:', previewUrl);
            
            // Format the URL as a clickable link
            const urlLink = '[' + previewUrl + '](' + previewUrl + ')';
            
            let comment = '## üåê Preview Deployment\n\n';
            comment += '**Branch:** `' + branch + '`\n';
            comment += '**Preview URL:** ' + urlLink + '\n';
            
            // Show atomic URL if different from preview URL
            if (atomicUrl && atomicUrl !== previewUrl) {
              const atomicLink = '[' + atomicUrl + '](' + atomicUrl + ')';
              comment += '**Atomic URL:** ' + atomicLink + ' (specific deployment)\n';
            }
            
            comment += '\n';
            comment += '> ‚ö†Ô∏è **Note:** The preview URL may take 1-2 minutes to become active. If you see "Nothing is here yet" or a Cloudflare Access login, wait a moment and refresh.\n';
            comment += '> \n';
            comment += '> You can also check the [Cloudflare Pages dashboard](https://dash.cloudflare.com/) for deployment status.';
            
            // Check if we've already commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            // Look for existing comment from this workflow
            // Match by "Preview Deployment" header and branch name
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment') &&
              comment.body.includes('`' + branch + '`')
            );
            
            try {
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
                console.log('‚úÖ Updated preview URL comment on PR #' + prNumber);
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
                console.log('‚úÖ Posted preview URL comment on PR #' + prNumber);
                console.log('Preview URL:', previewUrl);
              }
            } catch (error) {
              console.error('‚ùå Error posting comment to PR:', error.message);
              console.error('Error details:', error);
              throw error;
            }

  # Summary job that depends on all checks passing
  ci-success:
    runs-on: ubuntu-latest
    name: CI Success
    timeout-minutes: 1
    permissions:
      contents: read
    needs: [check-merge-commit, branch-protection, type-check, lint, test, build, deploy]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          # Check branch protection first
          if [ "${{ needs.branch-protection.result }}" == "failure" ]; then
            echo "‚ùå Branch protection check failed - direct push to main blocked"
            exit 1
          fi
          # Check other jobs (allow skipped results for draft PRs or path filtering)
          # Only fail if result is "failure", allow "success" or "skipped"
          check_job() {
            local result="$1"
            local job_name="$2"
            if [ "$result" == "failure" ]; then
              echo "‚ùå $job_name failed"
              return 1
            elif [ "$result" == "skipped" ]; then
              echo "‚è≠Ô∏è  $job_name skipped (draft PR or path filtering)"
              return 0
            elif [ "$result" == "success" ]; then
              echo "‚úÖ $job_name passed"
              return 0
            else
              echo "‚ö†Ô∏è  $job_name has unexpected result: $result"
              return 1
            fi
          }
          
          FAILED=0
          check_job "${{ needs.type-check.result }}" "Type check" || FAILED=1
          check_job "${{ needs.lint.result }}" "Lint" || FAILED=1
          check_job "${{ needs.test.result }}" "Test" || FAILED=1
          check_job "${{ needs.build.result }}" "Build" || FAILED=1
          check_job "${{ needs.deploy.result }}" "Deploy" || FAILED=1
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå One or more CI checks failed"
            exit 1
          fi
          echo ""
          echo "‚úÖ All CI checks passed or were skipped (as expected)"
