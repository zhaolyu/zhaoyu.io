# GitHub Actions workflow to automatically delete branches after PR merge
# 
# This workflow:
# - Triggers when a pull request is merged
# - Automatically deletes the source branch after merge
# - Only deletes branches that were merged (not closed without merging)
# - Skips deletion for protected branches (main, develop, etc.)

name: Auto Delete Branch on PR Merge

on:
  pull_request:
    types:
      - closed

jobs:
  delete-branch:
    runs-on: ubuntu-latest
    name: Delete Merged Branch
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get branch name
        id: branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch to delete: $BRANCH_NAME"

      - name: Check if branch is protected
        id: protected
        run: |
          BRANCH="${{ steps.branch.outputs.branch_name }}"
          PROTECTED_BRANCHES="main develop master"
          
          if echo "$PROTECTED_BRANCHES" | grep -q "\b$BRANCH\b"; then
            echo "is_protected=true" >> $GITHUB_OUTPUT
            echo "⚠️  Branch '$BRANCH' is protected and will not be deleted"
          else
            echo "is_protected=false" >> $GITHUB_OUTPUT
            echo "✅ Branch '$BRANCH' is not protected and can be deleted"
          fi

      - name: Delete branch
        if: steps.protected.outputs.is_protected == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              await github.rest.git.deleteRef({
                owner: owner,
                repo: repo,
                ref: `heads/${branchName}`
              });
              console.log(`✅ Successfully deleted branch: ${branchName}`);
            } catch (error) {
              // Branch might already be deleted or not exist
              if (error.status === 404) {
                console.log(`ℹ️  Branch ${branchName} was already deleted or doesn't exist`);
              } else {
                console.error(`❌ Error deleting branch ${branchName}:`, error.message);
                throw error;
              }
            }

      - name: Summary
        run: |
          if [ "${{ steps.protected.outputs.is_protected }}" == "true" ]; then
            echo "ℹ️  Branch '${{ steps.branch.outputs.branch_name }}' is protected and was not deleted"
          else
            echo "✅ Branch '${{ steps.branch.outputs.branch_name }}' has been deleted"
          fi
