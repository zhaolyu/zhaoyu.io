# Cleanup Preview Deployments
# 
# This workflow handles:
# - Deleting preview deployments when PRs are closed or merged
# - Cleaning up old preview deployments to save Cloudflare Pages quota
# 
# Note: Cloudflare Pages may have restrictions on deleting the latest deployment
# of a branch. This workflow attempts to delete all deployments for closed branches.

name: Cleanup Preview Deployments

on:
  # Trigger when PRs are closed (merged or closed without merging)
  pull_request:
    types: [closed]
  # Also trigger on branch deletion (when branch is deleted after PR merge)
  delete:

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    name: Cleanup Preview Deployment
    timeout-minutes: 5
    # Only run for branch deletions (not tags) and skip main branch
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'delete' && github.event.ref_type == 'branch' && github.event.ref != 'refs/heads/main')
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Determine branch name
        id: branch-info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR events, use the head branch (source branch)
            BRANCH="${{ github.event.pull_request.head.ref }}"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "Cleaning up preview deployments for PR branch: $BRANCH"
          elif [ "${{ github.event_name }}" = "delete" ]; then
            # For delete events, extract branch name from ref (e.g., refs/heads/feature-branch -> feature-branch)
            REF="${{ github.event.ref }}"
            BRANCH="${REF#refs/heads/}"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "Cleaning up preview deployments for deleted branch: $BRANCH"
          else
            echo "‚ùå Unsupported event type: ${{ github.event_name }}"
            exit 1
          fi
      
      - name: Skip cleanup for main branch
        if: steps.branch-info.outputs.branch == 'main'
        run: |
          echo "‚è≠Ô∏è  Skipping cleanup for main branch (production deployment)"
          exit 0
      
      - name: List deployments for branch
        id: list-deployments
        run: |
          BRANCH="${{ steps.branch-info.outputs.branch }}"
          PROJECT_NAME="zhaoyu-io"
          
          # Build the expected alias pattern (branch-name.zhaoyu-io.pages.dev)
          # Replace slashes with hyphens to match Cloudflare Pages format
          BRANCH_ALIAS=$(echo "$BRANCH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
          FULL_ALIAS="${BRANCH_ALIAS}.${PROJECT_NAME}.pages.dev"
          
          echo "Looking for deployments with alias: $FULL_ALIAS"
          
          # Fetch all deployments
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/${PROJECT_NAME}/deployments" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          # Check if API call was successful
          if echo "$RESPONSE" | jq -e '.success == false' > /dev/null 2>&1; then
            echo "‚ùå API Error: $(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"')"
            exit 1
          fi
          
          # Extract deployment IDs that match the branch alias
          DEPLOYMENT_IDS=$(echo "$RESPONSE" | jq -r --arg alias "$FULL_ALIAS" \
            '.result[] | select(.aliases[]? == $alias) | .id' | tr '\n' ' ')
          
          if [ -z "$DEPLOYMENT_IDS" ]; then
            echo "‚ÑπÔ∏è  No deployments found for branch: $BRANCH (alias: $FULL_ALIAS)"
            echo "deployment_ids=" >> $GITHUB_OUTPUT
            echo "DEPLOYMENT_COUNT=0" >> $GITHUB_ENV
          else
            echo "Found deployments: $DEPLOYMENT_IDS"
            echo "deployment_ids=$DEPLOYMENT_IDS" >> $GITHUB_OUTPUT
            echo "DEPLOYMENT_COUNT=$(echo "$DEPLOYMENT_IDS" | wc -w | tr -d ' ')" >> $GITHUB_ENV
          fi
      
      - name: Delete deployments
        if: steps.list-deployments.outputs.deployment_ids != ''
        run: |
          BRANCH="${{ steps.branch-info.outputs.branch }}"
          PROJECT_NAME="zhaoyu-io"
          DEPLOYMENT_IDS="${{ steps.list-deployments.outputs.deployment_ids }}"
          
          echo "Deleting deployments for branch: $BRANCH"
          
          DELETED=0
          FAILED=0
          
          for DEPLOYMENT_ID in $DEPLOYMENT_IDS; do
            echo "Deleting deployment: $DEPLOYMENT_ID"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects/${PROJECT_NAME}/deployments/${DEPLOYMENT_ID}" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "‚úÖ Successfully deleted deployment: $DEPLOYMENT_ID"
              DELETED=$((DELETED + 1))
            else
              # Check if it's because it's the latest deployment (which can't be deleted)
              if echo "$BODY" | jq -e '.errors[0].message' > /dev/null 2>&1; then
                ERROR_MSG=$(echo "$BODY" | jq -r '.errors[0].message')
                if echo "$ERROR_MSG" | grep -qi "latest\|active\|cannot delete" > /dev/null 2>&1; then
                  echo "‚ö†Ô∏è  Skipping deployment $DEPLOYMENT_ID (latest/active deployment cannot be deleted)"
                else
                  echo "‚ùå Failed to delete deployment $DEPLOYMENT_ID: $ERROR_MSG"
                  FAILED=$((FAILED + 1))
                fi
              else
                echo "‚ùå Failed to delete deployment $DEPLOYMENT_ID (HTTP $HTTP_CODE)"
                FAILED=$((FAILED + 1))
              fi
            fi
          done
          
          TOTAL_COUNT=$(echo "$DEPLOYMENT_IDS" | wc -w | tr -d ' ')
          SKIPPED=$((TOTAL_COUNT - DELETED - FAILED))
          
          echo ""
          echo "üìä Cleanup Summary:"
          echo "  - Total found: $TOTAL_COUNT"
          echo "  - Deleted: $DELETED"
          echo "  - Failed: $FAILED"
          echo "  - Skipped (latest): $SKIPPED"
      
      - name: Cleanup summary
        if: always()
        run: |
          if [ "${{ steps.list-deployments.outputs.deployment_ids }}" = "" ]; then
            echo "‚ÑπÔ∏è  No preview deployments found to clean up"
          elif [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Cleanup completed successfully"
          else
            echo "‚ö†Ô∏è  Cleanup completed with warnings (some deployments may still exist)"
          fi
